 <% layout("/layout/boilerplate") %>

<div class="container">
  <h1><%= listing.title %></h1>
  <div class="listing-info">
    <p><strong>Description:</strong> <%= listing.description %></p>
    <p><strong>Price:</strong> â‚¹<%= listing.price %></p>
    <p><strong>Location:</strong> <%= listing.location %></p>
    <p><strong>Country:</strong> <%= listing.country %></p>
  </div>
  <% if (listing.images && listing.images.length > 0) { %>
    <div class="images">
      <% listing.images.forEach(function(image) { %>
        <img src="<%= image %>" alt="Listing Image" />
      <% }); %>
    </div>
  <% } %>
  <a href="/listings" class="back-link">Back to Listings</a>

  <div id="existingReviewsContainer" class="row g-3" style="margin-bottom: 20px;">
    <% if (listing.reviews && listing.reviews.length > 0) { %>
      <% listing.reviews.forEach(function(review) { %>
        <div class="col-md-6 mb-3" id="review-<%= review._id %>">
          <div class="card">
            <div class="card-body d-flex justify-content-between align-items-center">
              <div>
                <div class="starability-result" data-rating="<%= review.rating %>"></div>
                <p class="card-text"><%= review.comment %></p>
                <p class="card-text"><small>Author: <%= review.owner ? review.owner.username : 'Unknown' %></small></p>
              </div>
              <% if (user && review.owner && user._id.toString() === review.owner._id.toString()) { %>
                <button class="btn btn-danger btn-sm delete-review-btn" data-review-id="<%= review._id %>">Delete</button>
              <% } %>
            </div>
          </div>
        </div>
      <% }); %>
    <% } %>
  </div>
  <div id="newReviewsContainer" class="row g-3" style="margin-bottom: 20px;"></div>

  <div class="review-form-container card p-4 shadow-sm rounded-3 my-4">
    <h2 class="mb-4">Leave a Review</h2>
    <form id="reviewForm" class="review-form needs-validation" novalidate>
      <div class="mb-3">
        <label class="form-label">Rating:</label>
        <div class="starability-slot">
          <input type="radio" id="rate5" name="rating" value="5" required />
          <label for="rate5" title="Excellent">5 stars</label>
          <input type="radio" id="rate4" name="rating" value="4" />
          <label for="rate4" title="Good">4 stars</label>
          <input type="radio" id="rate3" name="rating" value="3" />
          <label for="rate3" title="Average">3 stars</label>
          <input type="radio" id="rate2" name="rating" value="2" />
          <label for="rate2" title="Poor">2 stars</label>
          <input type="radio" id="rate1" name="rating" value="1" />
          <label for="rate1" title="Very Poor">1 star</label>
        </div>
        <div class="invalid-feedback">
          Please select a rating.
        </div>
      </div>
      <div class="mb-3">
        <label for="review" class="form-label">Review:</label>
        <textarea id="review" name="comment" class="form-control" rows="4" required placeholder="Write your review here..."></textarea>
        <div class="invalid-feedback">
          Please write a review.
        </div>
      </div>
      <button type="button" id="submitReviewBtn" class="btn btn-success btn-lg w-100">Submit Review</button>
    </form>
    <div id="reviewMessage" class="mt-3"></div>
  </div>

  <div id="listing-map" style="width: 100%; height: 400px; min-height: 400px; margin-bottom: 20px;"></div>

  <link href='https://api.mapbox.com/mapbox-gl-js/v2.15.0/mapbox-gl.css' rel='stylesheet' />
  <script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyCfFgzMHCCGvrDxx48P_inRDk-Z3oM2RDg&callback=initListingMap" async defer></script>
  <script>
    const listingData = <%= JSON.stringify(listing) %>;

    function initListingMap() {
      const mapOptions = {
        zoom: 10,
        center: { lat: 20.5937, lng: 78.9629 } // Default center (India)
      };

      const map = new google.maps.Map(document.getElementById('listing-map'), mapOptions);

      if (listingData.location) {
        const geocoder = new google.maps.Geocoder();
        geocoder.geocode({ address: listingData.location }, (results, status) => {
          if (status === 'OK' && results[0]) {
            const location = results[0].geometry.location;
            map.setCenter(location);

            const marker = new google.maps.Marker({
              map: map,
              position: location,
              title: listingData.title
            });

            const infoWindow = new google.maps.InfoWindow({
              content: `<h3>${listingData.title}</h3><p>${listingData.location}</p>`
            });

            marker.addListener('click', () => {
              infoWindow.open(map, marker);
            });
          } else {
            console.error('Geocode was not successful for the following reason: ' + status);
          }
        });
      }
    }
  </script>

  <script src="/scripts/listingReviews.js"></script>
</div>
